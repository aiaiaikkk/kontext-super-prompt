# 双人脸对齐功能使用指南

## 🎯 功能说明

**双人脸对齐**是为换脸操作设计的专业预处理功能，通过智能分析两张图像中的人脸特征，自动调整前景图人脸的角度、大小和位置，使其与背景图人脸完美匹配。

### 📋 适用场景
- **背景图**：半侧脸、正脸、任意角度的人物照片
- **前景图**：需要替换到背景图的人脸照片
- **目标**：让前景人脸完美匹配背景人脸的朝向和尺寸
- **用途**：为ComfyUI换脸节点提供精确的预处理

## 🚀 快速上手

### 基本操作流程

#### **步骤1：准备图像**
```
画布操作：
1. 加载背景图（包含目标人脸位置）
2. 添加前景图（包含要替换的人脸）
```

#### **步骤2：切换对齐模式**
```
面部工具栏：
1. 展开面部工具面板
2. 选择 "双脸对齐" 模式（而非"单图处理"）
```

#### **步骤3：设置参考脸和源脸**
```
操作顺序：
1. 点击选择背景图 → 点击 [🎯 设置参考脸]
2. 点击选择前景图 → 点击 [👤 设置源脸]
```

#### **步骤4：执行对齐**
```
对齐操作：
1. 选择对齐预设（精确/保守/仅角度/仅尺寸）
2. 点击 [⚡ 执行对齐] 按钮
3. 查看自动对齐结果
```

#### **步骤5：微调优化（可选）**
```
手动微调：
1. 使用滑块调整旋转角度、缩放比例、位移
2. 点击 [✅ 应用微调] 确认调整
3. 随时可以 [↺ 重置] 回到初始状态
```

## 🎮 详细操作说明

### 界面布局

工具栏切换到双脸对齐模式后显示：

```
┌─────────────────────────────────────────┐
│ 🪄 智能面部处理                    ▼    │
├─────────────────────────────────────────┤
│ 对齐模式: ○ 单图处理 ● 双脸对齐          │
├─────────────────────────────────────────┤
│ 换脸预处理:                             │
│ [🎯 设置参考脸] [👤 设置源脸]            │
│ 对齐预设: [精确对齐 ▼]                  │
│ [⚡ 执行对齐] [📊 匹配度]                │
├─────────────────────────────────────────┤
│ 手动微调:                               │
│ 旋转角度: ████████░░ 0°                 │
│ 缩放比例: ████████░░ 0%                 │
│ 水平位移: ████████░░ 0px                │
│ 垂直位移: ████████░░ 0px                │
│ [✅ 应用微调] [↺ 重置]                  │
└─────────────────────────────────────────┘
```

### 具体操作步骤

#### **1. 设置参考脸（目标脸）**

**操作**：选择背景图 → 点击"设置参考脸"

**效果**：
- 系统自动检测背景图中的人脸
- 显示检测置信度（如：85%）
- 该人脸将作为对齐的目标标准

**注意事项**：
- 选择清晰度高的人脸
- 确保人脸角度符合预期效果
- 如有多个人脸，系统选择最大的

#### **2. 设置源脸（要调整的脸）**

**操作**：选择前景图 → 点击"设置源脸"

**效果**：
- 检测前景图中的人脸
- 显示检测置信度
- 该人脸将被调整以匹配参考脸

**提示**：
- 尽量选择与参考脸相似角度的照片
- 避免过度遮挡或模糊的人脸

#### **3. 选择对齐预设**

**精确对齐**：
- 完全匹配参考脸的角度、大小、位置
- 适合：角度差异不大的情况
- 效果：最精确的匹配

**保守对齐**：
- 调整角度和大小，保持部分原始位置
- 适合：希望保留一些原始特征
- 强度：70%的对齐强度

**仅角度对齐**：
- 只调整人脸朝向，不改变大小和位置
- 适合：大小已合适，只需要角度校正
- 用途：朝向不一致的情况

**仅尺寸对齐**：
- 只调整人脸大小，不改变角度和位置
- 适合：角度已正确，只需要尺寸匹配
- 场景：远近距离差异较大

#### **4. 查看匹配度评分**

点击"匹配度"按钮可查看：

**综合评分**：0-100分
- 80-100分：优秀，可直接使用
- 60-79分：良好，建议微调
- 40-59分：一般，需要调整
- 0-39分：较差，建议重新选择

**分项评分**：
- **角度匹配**：双眼水平线角度相似度
- **尺寸匹配**：人脸区域大小相似度

**智能建议**：
- 系统根据评分提供优化建议
- 指导下一步操作方向

#### **5. 手动微调控制**

对齐完成后，可进行精细调整：

**旋转角度**：-45°到+45°
- 调整人脸朝向的细微偏差
- 实时预览旋转效果

**缩放比例**：-50%到+50%
- 微调人脸大小
- 正值放大，负值缩小

**水平位移**：-100px到+100px
- 左右位置调整
- 对齐脸部中心线

**垂直位移**：-100px到+100px
- 上下位置调整
- 匹配眼部高度

## 💡 使用技巧

### 最佳实践

**1. 照片选择**
```
✅ 推荐：
- 光线充足、清晰度高
- 角度相近（相差不超过30°）
- 人脸尺寸适中（不要太小）
- 遮挡较少

❌ 避免：
- 模糊、暗光照片
- 角度差异过大
- 严重遮挡或侧脸
- 表情差异极大
```

**2. 操作顺序**
```
建议流程：
1. 先用"仅角度对齐"校正朝向
2. 再用"仅尺寸对齐"调整大小
3. 最后用"精确对齐"整体优化
4. 手动微调进行细节完善
```

**3. 效果验证**
```
检查要点：
- 双眼是否水平对齐
- 鼻尖位置是否匹配
- 脸部轮廓是否贴合
- 整体比例是否协调
```

### 常见问题解决

**❓ 检测不到人脸**
```
解决方案：
1. 确保图像清晰度足够
2. 调整图像亮度和对比度
3. 选择更正面的角度
4. 检查网络连接（首次需要下载模型）
```

**❓ 对齐效果不理想**
```
优化建议：
1. 尝试不同的对齐预设
2. 使用手动微调进行精细调整
3. 检查两张照片的相似性
4. 确保参考脸选择正确
```

**❓ 匹配度评分较低**
```
改进方法：
1. 选择角度更相近的照片
2. 确保两张照片光线条件相似
3. 避免表情差异过大的照片
4. 优先选择正面或微侧面照片
```

**❓ 处理速度较慢**
```
优化方案：
1. 降低图像分辨率
2. 关闭不必要的浏览器标签
3. 等待MediaPipe模型加载完成
4. 使用性能更好的设备
```

## 🔧 高级功能

### 批量对齐处理

虽然双脸对齐主要针对单对图像，但可以通过以下方式提高效率：

**1. 相同参考脸处理多个源脸**
```
操作：
1. 设置一个参考脸
2. 依次设置不同的源脸
3. 使用相同预设进行对齐
```

**2. 参数记录和复用**
```
技巧：
1. 记录成功的微调参数
2. 在相似情况下复用这些参数
3. 建立个人的参数库
```

### 与换脸节点集成

完成对齐后，在ComfyUI中使用：

**1. 导出对齐后的图像**
```
方法：
1. 右键保存对齐后的前景图
2. 确保保存为高质量格式
3. 导入到ComfyUI工作流
```

**2. 换脸节点参数调整**
```
优化：
1. 降低换脸节点的对齐强度
2. 因为已经预对齐，可以提高融合质量
3. 减少后处理的复杂度
```

## 📊 技术参数

### 检测精度
- **人脸检测准确率**：95%以上
- **关键点定位精度**：亚像素级别
- **角度检测误差**：±2度以内
- **尺寸匹配精度**：±5%以内

### 性能指标
- **单次对齐时间**：2-5秒
- **支持图像尺寸**：最大4096x4096
- **内存占用**：约50MB
- **浏览器兼容**：Chrome 80+, Firefox 75+

### 算法特点
- **Procrustes分析**：几何变换算法
- **关键点匹配**：468个面部特征点
- **实时预览**：即时反馈调整效果
- **本地处理**：保护用户隐私

---

**提示**：双人脸对齐是一个强大的预处理工具，合理使用可以大大提高换脸效果的质量和自然度。建议在实际应用中多尝试不同的预设和参数组合，找到最适合的配置。