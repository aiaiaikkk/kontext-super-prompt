# 图像自动缩放功能说明

## 概述

为 Kontext-Super-Prompt 项目添加了图像自动缩放功能，当图片尺寸超过 1280×1280 像素时，会自动缩放到适合的显示尺寸，同时保留原始分辨率数据。

## 功能特性

### 1. 自动缩放
- **最大显示尺寸**: 1280×1280 像素
- **保持宽高比**: 缩放时保持图像原始比例
- **智能调整**: 只对大图像进行缩放，小图像保持原尺寸

### 2. 精度保持
- **坐标转换**: 显示坐标与原始坐标双向转换
- **数据分离**: 显示尺寸和原始尺寸分别存储
- **无损操作**: 所有编辑操作基于原始分辨率

### 3. 用户体验
- **性能优化**: 大图片显示更流畅
- **内存节省**: 减少大图片占用的内存
- **信息透明**: UI 显示实际和原始尺寸信息

## 实现细节

### 新增文件
- `visual_prompt_editor_image_scaling.js` - 图像缩放管理器
- `image_scaling_demo.html` - 功能演示页面

### 修改文件
- `visual_prompt_editor_fabric_native.js` - 集成缩放功能到 Fabric.js
- `visual_prompt_editor_modal_core.js` - 处理输入图像自动缩放

### 核心类
```javascript
ImageScalingManager {
    // 计算显示尺寸
    calculateDisplaySize(originalWidth, originalHeight)
    
    // 坐标转换
    displayToOriginalCoordinates(imageId, displayX, displayY)
    originalToDisplayCoordinates(imageId, originalX, originalY)
    
    // 数据管理
    storeOriginalSize(imageId, width, height)
    getOriginalSize(imageId)
}
```

## 使用示例

### 1. 大图片自动缩放
```
输入: 2000×1500 像素
输出: 1280×960 像素 (64% 缩放)
画布: ~1380×1060 像素
```

### 2. 小图片保持原样
```
输入: 800×600 像素
输出: 800×600 僆素 (100% 原始尺寸)
画布: 800×600 像素
```

## UI 显示

### 图层列表
图像对象在图层列表中显示尺寸信息：
- `🖼️ 图片 (1280×960, 原始: 2000×1500) (层级: 0)` - 已缩放
- `🖼️ 图片 (800×600) (层级: 1)` - 原始尺寸

### 控制台日志
加载大图片时会输出缩放信息：
```
📏 图像已自动缩放: 2000×1500 → 1280×960 (64%)
```

## 注意事项

1. **兼容性**: 新功能向后兼容，不影响现有功能
2. **性能**: 大图片加载性能显著提升
3. **精度**: 所有编辑操作保持原始精度
4. **内存**: 减少大图片导致的内存压力

## 测试建议

1. 测试不同尺寸的图片加载
2. 验证图层列表尺寸显示正确
3. 检查坐标转换准确性
4. 确认画布尺寸自动调整

## 后续优化

1. 添加用户配置选项（可调整 MAX_DISPLAY_SIZE）
2. 实现图片质量优化（如 WebP 格式）
3. 添加批量图片处理功能
4. 优化内存管理机制